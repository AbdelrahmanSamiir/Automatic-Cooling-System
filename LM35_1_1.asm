IO_DECLERATION:
    	LCD_PORT EQU	P1
    	RS 	EQU 	P3.0 
	EN 	EQU 	P3.1

	ADC_WR	EQU	P3.5

	FAN	EQU	P3.4
	
	PWM_PIN EQU FAN
	PWM_FLAG EQU 0	
	JMP PWM_SETUP




	TEMP	EQU	30H
	PSET	EQU	31H
	L_NRML  EQU	32H
	H_NRML	EQU	33H
	
	

    ORG	0		
	LJMP	MAIN	
    ORG 0BH		
	JMP TIMER0_ISR
    ORG	30H	

MAIN:	

	MOV 	P3,#00H
	MOV 	P1,#00H
	MOV 	P2,#0FFH
	MOV 	P0,#0FFH


	MOV	L_NRML,#28D
	MOV	H_NRML,#35D

	LCALL	LCD_INIT
	MOV 	R0, #80H
	ACALL 	CMND_WRT
	MOV	DPTR, #MSG1
	ACALL	PRNT_STRNG
	


MAIN_LOOP:
	MOV 	R0, #08BH
	ACALL 	CMND_WRT
	
	CLR	ADC_WR
	SETB	ADC_WR
RD_ADC:
	MOV	A,P2
	MOV	TEMP,A
	ACALL	BIN_2_ASCII
	ACALL	CHECK_TEMP
	LJMP	MAIN_LOOP


PWM_SETUP:
	MOV TMOD,#00H 	
	MOV R7, #128	
	SETB EA 	
	SETB ET0 	
	SETB TR0 	
	JMP $		
	
	
TIMER0_ISR:			
	JB PWM_FLAG, LOW_PERIOD	
						
HIGH_PERIOD:			
	SETB PWM_FLAG		
	SETB FAN		
	MOV A, #0FFH		
	CLR C			
	SUBB A, R7		
				
	MOV TH0, A		
	CLR TF0			
	
	RETI			
	
LOW_PERIOD:
	CLR PWM_FLAG		
	CLR FAN		
	MOV TH0, R7		
	CLR TF0			
	
	RETI			
				
PWM_STOP:
	CLR TR0			
	RET
		

CHECK_TEMP:

	MOV	A,TEMP
	SUBB	A,H_NRML
	JNC	_HI
	MOV	A,TEMP
	SUBB	A,L_NRML
	JC	_LO

_HI:
	JMP	TMP_HI
_LO:
	JMP	TMP_LO


TMP_HI:
	SETB	FAN
	SETB 	TR1
	MOV	DPTR, #STR_HI
	LCALL	PRNT_STAT
	RET

TMP_LO:
	CLR	FAN


	SETB 	TR1
	MOV	DPTR, #STR_LO
	LCALL	PRNT_STAT
	RET


PRNT_STAT:		
	MOV 	R0,#0C0H
	ACALL 	CMND_WRT
PRNT_STRNG:	
	CLR	A
	MOVC	A, @A+DPTR
	MOV 	R0, A
	JZ	END_STRNG
	ACALL 	DATA_WRT	
	ACALL 	DELAY		
	INC	DPTR
	SJMP	PRNT_STRNG
END_STRNG:
	RET
	
BIN_2_ASCII:
	MOV 	R7,#10D
	MOV 	A, TEMP	
	MOV 	B,R7
	DIV 	AB
	ADD 	A,#30H	
	MOV 	R0,A
	ACALL 	DATA_WRT
	MOV 	A,B		
	ADD 	A, #30H
	MOV 	R0,A
	ACALL 	DATA_WRT
	RET

LCD_INIT:
	MOV 	R0, #38H
	ACALL 	CMND_WRT
	MOV 	R0, #0EH
	ACALL 	CMND_WRT
	MOV 	R0, #01H
	ACALL 	CMND_WRT
	MOV 	A,#06H 	
	ACALL 	CMND_WRT
	MOV 	R0, #80H
	ACALL 	CMND_WRT
	MOV 	A,#3CH 		
	ACALL 	CMND_WRT
	RET

DATA_WRT:
	MOV 	LCD_PORT, R0
	SETB 	RS
	SETB 	EN
	ACALL 	DELAY
	CLR 	EN
	RET

CMND_WRT:
	MOV 	LCD_PORT, R0
	CLR 	RS
	SETB 	EN
	ACALL 	DELAY
	CLR 	EN
	RET

DELAY:	MOV 	62, #2	
DELAY1:	MOV 	61, #50
DELAY_:	MOV 	60, #200
	DJNZ 	60, $
	DJNZ 	61, DELAY_
	DJNZ 	62, DELAY1
	RET

ORG 	200H
	MSG1: 	DB "Temp:",0
	STR_HI: DB 'HIGH  ',0
	STR_LO: DB 'LOW   ',0
	
	END